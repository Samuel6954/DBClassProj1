<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>系統權限維護 | DBProj01_12_Role</title>
  <link rel="stylesheet" href="assets/tech.css" />
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="topbar-inner">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">ERP 稽核輔助｜系統權限維護</div>
        <div class="breadcrumbs">首頁 / 基礎資料 / 系統權限維護</div>
      </div>
    </header>

    <main class="container">
      <form class="panel subtle-grid" autocomplete="off" onsubmit="return false;">
        <div class="panel-header">
          <div class="panel-title">權限資料</div>
          <div class="panel-actions">
            <a class="btn" href="/Role">返回清單</a>
          </div>
        </div>
        <div class="panel-body">
          <div class="grid">
            <div class="col-6">
              <label for="RoleId">權限代碼</label>
              <input id="RoleId" name="RoleId" type="text" placeholder="HR-ADMIN" required />
            </div>
            <div class="col-6">
              <label for="RoleName">權限名稱</label>
              <input id="RoleName" name="RoleName" type="text" placeholder="人資管理員" required />
            </div>
            <div class="col-12">
              <label class="checkbox"><input id="VisibleMark" name="VisibleMark" type="checkbox" checked /> 是否顯示（勾選為顯示）</label>
            </div>
            <div class="col-12 form-actions">
              <button class="btn danger" type="button" id="btnDelete" disabled>刪除</button>
              <div class="right"></div>
              <button class="btn" type="reset" id="btnClear">清除</button>
              <button class="btn success" type="button" id="btnSave">儲存</button>
            </div>
          </div>
        </div>
      </form>
    </main>

    <footer class="footer">提示：若以參數開啟（ModifyRole?RoleId=XXX）即為編輯模式，否則為新增模式。</footer>
  </div>
  <script>
    function getQuery(name){ const u=new URL(location.href); return u.searchParams.get(name)||''; }
    function qs(sel, root=document){ return root.querySelector(sel); }
    const inpRoleId = qs('#RoleId');
    const inpRoleName = qs('#RoleName');
    const chkVisible = qs('#VisibleMark');
    const btnSave = qs('#btnSave');
    const btnDelete = qs('#btnDelete');
    const btnClear = qs('#btnClear');

    async function fetchJSON(url, options){
      const r = await fetch(url, options);
      if (!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }

    let MODE = 'insert'; // insert | update
    async function loadData(){
      const roleId = getQuery('RoleId');
      if (!roleId){ inpRoleId.readOnly = false; MODE = 'insert'; return; }
      try{
        const data = await fetchJSON('/api/role?RoleId=' + encodeURIComponent(roleId));
        if (!data || !data.RoleId){ alert('沒有此代碼的角色：' + roleId); history.back(); return; }
        inpRoleId.value = data.RoleId || '';
        inpRoleName.value = data.RoleName || '';
        chkVisible.checked = !!data.VisibleMark;
        inpRoleId.readOnly = true;
        btnDelete.disabled = false;
        MODE = 'update';
      }catch(e){ console.error(e); alert('讀取資料失敗'); history.back(); }
    }

    async function onSave(){
      const payload = {
        RoleId: (inpRoleId.value||'').trim(),
        RoleName: (inpRoleName.value||'').trim(),
        VisibleMark: !!chkVisible.checked,
      };
      if (!payload.RoleId || !payload.RoleName){ alert('請完整填寫代碼與名稱'); return; }
      try{
        const res = await fetchJSON('/api/role', {
          method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload)
        });
        if (!res || !res.ok){ alert('儲存失敗'); return; }
        alert((res.mode==='insert'?'已新增':'已儲存'));
      }catch(e){ console.error(e); alert('儲存時發生錯誤'); }
    }

    btnSave.addEventListener('click', async () => {
      const payload = {
        RoleId: (inpRoleId.value||'').trim(),
        RoleName: (inpRoleName.value||'').trim(),
        VisibleMark: !!chkVisible.checked,
        mode: MODE,
      };
      if (MODE === 'insert'){
        // 先檢查是否重複
        try{
          const exist = await fetch('/api/role?RoleId=' + encodeURIComponent(payload.RoleId));
          if (exist.ok){
            alert('代碼已存在，請更換 RoleId');
            return;
          }
        }catch(_){ /* ignore */ }
      }
      // 呼叫儲存（區分 insert/update 由後端 mode 控制）
      try{
        const r = await fetch('/api/role', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const res = await r.json();
        if (!r.ok || !res.ok){ alert(res.error || '儲存失敗'); return; }
        alert(res.mode==='insert' ? '已新增' : '已儲存');
        if (res.mode==='insert'){
          // 轉為編輯模式
          location.href = '/ModifyRole?RoleId=' + encodeURIComponent(payload.RoleId);
        }
      }catch(e){ console.error(e); alert('儲存時發生錯誤'); }
    });
    btnClear.addEventListener('click', () => { if (!inpRoleId.readOnly) inpRoleId.value=''; inpRoleName.value=''; chkVisible.checked=true; });
    btnDelete.addEventListener('click', async () => {
      const rid = inpRoleId.value.trim();
      if (!rid){ return; }
      if (!confirm('確定要刪除角色：' + rid + '？')) return;
      try{
        const r = await fetch('/api/role?RoleId=' + encodeURIComponent(rid), { method: 'DELETE' });
        if (!r.ok){ const t = await r.text(); throw new Error(t); }
        const data = await r.json();
        if (!data || !data.ok){ alert('刪除失敗'); return; }
        alert('已刪除');
        window.location.href = '/Role';
      }catch(e){ console.error(e); alert('刪除時發生錯誤'); }
    });
    loadData();
  </script>
</body>
</html>
