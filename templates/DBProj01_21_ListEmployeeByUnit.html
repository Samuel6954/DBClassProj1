<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>單位員工查詢 | DBProj01_21_ListEmployeeByUnit</title>
  <link rel="stylesheet" href="assets/tech.css" />
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="topbar-inner">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">ERP 稽核輔助｜單位員工查詢</div>
        <div class="breadcrumbs"><a href="/" style="text-decoration:none;color:inherit;">首頁</a> / 人事資料 / 單位員工查詢</div>
      </div>
    </header>

    <main class="container">
      <!-- Filter -->
      <section class="panel subtle-grid">
        <div class="panel-header">
          <div class="panel-title">查詢條件</div>
          <div class="panel-actions">
            <button id="btnReset" class="btn" type="button">清除</button>
            <button id="btnFilter" class="btn primary" type="button">查詢</button>
          </div>
        </div>
        <div class="panel-body">
          <div class="grid">
            <div class="col-6">
              <label for="selUnit">僅顯示某單位</label>
              <select id="selUnit"></select>
            </div>
            <div class="col-6">
              <label>&nbsp;</label>
              <div class="badge">提示：點選單位可展開員工</div>
            </div>
          </div>
        </div>
      </section>

      <div class="spacer"></div>

      <!-- Units -->
      <section class="panel" id="panelUnits">
        <div class="panel-header">
          <div class="panel-title">單位清單</div>
          <div class="panel-actions hint" id="unitCountHint">顯示 0，共 0 筆</div>
        </div>
        <div class="panel-body">
          <div class="table-wrap">
            <table id="tblUnits">
              <thead>
                <tr>
                  <th>單位代碼</th>
                  <th>單位名稱</th>
                  <th>主管姓名</th>
                  <th>員工數</th>
                  <th>說明</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <div class="spacer"></div>

      <!-- Employees of unit -->
      <section class="panel" id="panelEmployees">
        <div class="panel-header">
          <div class="panel-title">單位員工 <span id="empUnitTitle" class="badge"></span></div>
          <div class="panel-actions hint" id="empCountHint">尚未選擇單位</div>
        </div>
        <div class="panel-body">
          <div class="table-wrap">
            <table id="tblEmployees">
              <thead>
                <tr>
                  <th>工號</th>
                  <th>姓名</th>
                  <th>職稱</th>
                  <th>系統權限</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <div class="spacer"></div>

      <!-- Programs of employee -->
      <section class="panel" id="panelPrograms">
        <div class="panel-header">
          <div class="panel-title">員工可用程式 <span id="progEmpTitle" class="badge"></span></div>
          <div class="panel-actions hint" id="progCountHint">尚未選擇員工</div>
        </div>
        <div class="panel-body">
          <div class="table-wrap">
            <table id="tblPrograms">
              <thead>
                <tr>
                  <th>程式代碼</th>
                  <th>程式名稱</th>
                  
                  <th>說明</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer">
      提示：可使用 <span class="kbd">/</span> 聚焦搜尋，點選單位或員工以展開明細。
    </footer>
  </div>

  <script>
  // Utilities
  function esc(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
  async function fetchJSON(url){ const r = await fetch(url); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }

  // Elements
  const selUnit = document.getElementById('selUnit');
  const tblUnitsBody = document.querySelector('#tblUnits tbody');
  const unitCountHint = document.getElementById('unitCountHint');

  const tblEmpBody = document.querySelector('#tblEmployees tbody');
  const empUnitTitle = document.getElementById('empUnitTitle');
  const empCountHint = document.getElementById('empCountHint');

  const tblProgBody = document.querySelector('#tblPrograms tbody');
  const progEmpTitle = document.getElementById('progEmpTitle');
  const progCountHint = document.getElementById('progCountHint');

  const btnFilter = document.getElementById('btnFilter');
  const btnReset = document.getElementById('btnReset');

  let currentUnitId = '';
  let currentEmpId = '';
  let rolesMap = Object.create(null);

  async function loadRolesMap(){
    try{
      const data = await fetchJSON('/api/roles');
      for (const r of (Array.isArray(data)?data:[])){
        if (r && r.RoleId) rolesMap[r.RoleId] = r.RoleName || r.RoleId;
      }
    }catch(e){ console.error(e); }
  }

  async function loadUnitOptions() {
    selUnit.innerHTML = '';
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = '（請選擇單位）';
    selUnit.appendChild(opt);
    try{
      const data = await fetchJSON('/api/units/all?limit=9999');
      for (const it of (Array.isArray(data)?data:[])){
        const o = document.createElement('option');
        o.value = it.UnitId || '';
        o.textContent = `${it.UnitId || ''}｜${it.UnitName || ''}`;
        selUnit.appendChild(o);
      }
    }catch(e){ console.error(e); }
  }

  function renderUnitsFromApi(list){
    tblUnitsBody.innerHTML = '';
    const arr = Array.isArray(list) ? list : [];
    for (const u of arr){
      const uid = u.UnitId || '';
      const tr = document.createElement('tr');
      tr.style.cursor = 'pointer';
      tr.dataset.unitId = uid;
      tr.innerHTML = `
        <td>${esc(uid)}</td>
        <td>${esc(u.UnitName || '')}</td>
        <td>${esc(u.ManagerName || '')}</td>
        <td></td>
        <td>${esc(u.WorkIntroduce || '')}</td>
      `;
      tr.addEventListener('click', () => selectUnit(uid, u.UnitName||''));
      tblUnitsBody.appendChild(tr);
    }
    unitCountHint.textContent = `顯示 ${arr.length} 筆`;
  }

  async function selectUnit(unitId, unitName) {
    currentUnitId = unitId || '';
    selUnit.value = unitId || '';
    // Render employees by API
    tblEmpBody.innerHTML = '';
    empUnitTitle.textContent = unitId ? `單位：${unitId}｜${unitName||''}` : '';
    empCountHint.textContent = '查詢中...';
    try{
      const data = await fetchJSON('/api/employees?UnitId=' + encodeURIComponent(unitId));
      const arr = Array.isArray(data) ? data : [];
      for (const e of arr) {
        const tr = document.createElement('tr');
        tr.style.cursor = 'pointer';
        tr.dataset.empId = e.EmployeeId || '';
        tr.innerHTML = `
          <td>${esc(e.EmployeeId || '')}</td>
          <td>${esc(e.EmployeeName || '')}</td>
          <td>${esc(e.JobName || '')}</td>
          <td>${esc(rolesMap[e.RoleId] || e.RoleId || '')}</td>
        `;
        tr.addEventListener('click', () => selectEmployee(e.EmployeeId || '', e.EmployeeName || '', e.RoleId || ''));
        tblEmpBody.appendChild(tr);
      }
      empCountHint.textContent = `顯示 ${arr.length} 筆`;
    }catch(e){ console.error(e); empCountHint.textContent = '讀取失敗'; }
    // Clear program panel
    selectEmployee('');
  }

  async function selectEmployee(empId, empName, roleId) {
    currentEmpId = empId || '';
    tblProgBody.innerHTML = '';
    if (!empId) {
      progEmpTitle.textContent = '';
      progCountHint.textContent = '尚未選擇員工';
      return;
    }
    progEmpTitle.textContent = `員工：${empId}｜${empName||''}`;
    progCountHint.textContent = '查詢中...';
    try{
      const rid = roleId || '';
      const data = await fetchJSON('/api/role/programs?RoleId=' + encodeURIComponent(rid));
      const arr = Array.isArray(data) ? data : [];
      for (const p of arr) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${esc(p.ProgId || '')}</td>
          <td>${esc(p.ProgName || '')}</td>
          <td></td>
        `;
        tblProgBody.appendChild(tr);
      }
      progCountHint.textContent = `顯示 ${arr.length} 筆`;
    }catch(e){ console.error(e); progCountHint.textContent = '讀取失敗'; }
  }

  // Wire up buttons
  btnFilter.addEventListener('click', async () => {
    const unitId = selUnit.value || '';
    tblUnitsBody.innerHTML = '';
    unitCountHint.textContent = unitId ? '查詢中...' : '請先選擇單位';
    tblEmpBody.innerHTML = '';
    empUnitTitle.textContent = '';
    empCountHint.textContent = '尚未選擇單位';
    selectEmployee('');
    if (!unitId) return; // 預設不查詢（無選擇時不列出清單）
    try{
      const data = await fetchJSON('/api/units?UnitId=' + encodeURIComponent(unitId));
      renderUnitsFromApi(data);
    }catch(e){ console.error(e); unitCountHint.textContent = '讀取失敗'; }
  });

  btnReset.addEventListener('click', () => {
    selUnit.value = '';
    currentUnitId = '';
    currentEmpId = '';
    tblUnitsBody.innerHTML = '';
    unitCountHint.textContent = '顯示 0，共 0 筆';
    tblEmpBody.innerHTML = '';
    empUnitTitle.textContent = '';
    empCountHint.textContent = '未篩選單位';
    selectEmployee('');
  });

  // Initialize（預設不要查詢，只載入下拉選項）
  loadUnitOptions();
  loadRolesMap();
  tblUnitsBody.innerHTML = '';
  unitCountHint.textContent = '顯示 0，共 0 筆';
  empCountHint.textContent = '未篩選單位';
  progCountHint.textContent = '尚未選擇員工';
  </script>
</body>
<!-- DBProj01_21_ListEmployeeByUnit -->
</html>
