<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>程式代碼管理 | DBProj01_05_Program</title>
  <link rel="stylesheet" href="assets/tech.css" />
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="topbar-inner">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">ERP 稽核輔助｜程式代碼管理</div>
        <div class="breadcrumbs"><a href="/" style="text-decoration:none;color:inherit;">首頁</a> / 程式代碼管理</div>
      </div>
    </header>

    <main class="container">
      <!-- 查詢條件 -->
      <section class="panel subtle-grid">
        <div class="panel-header">
          <div class="panel-title">查詢條件</div>
          <div class="panel-actions"><a class="btn primary" href="/ModifyProgram">新增</a></div>
        </div>
        <div class="panel-body">
          <div class="grid">
            <div class="col-4">
              <label for="qProgId">程式代碼</label>
              <input id="qProgId" type="search" placeholder="例如：PRG_RECRUIT_APPLY" />
            </div>
            <div class="col-4">
              <label for="qProgName">程式名稱</label>
              <input id="qProgName" type="search" placeholder="例如：招募申請" />
            </div>
            <div class="col-12">
              <div class="form-actions">
                <button id="btnClearProg" class="btn" type="button">清除</button>
                <button id="btnSearchProg" class="btn primary" type="button">查詢</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <div class="spacer"></div>

      <!-- 查詢結果 -->
      <section class="panel">
        <div class="panel-header">
          <div class="panel-title">查詢結果</div>
          <div class="panel-actions hint" id="hint">顯示 0 筆</div>
        </div>
        <div class="panel-body">
          <div class="table-wrap">
            <table id="tblPrograms">
              <thead>
                <tr>
                  <th>程式代碼</th>
                  <th>程式名稱</th>
                  <th>使用人數</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
      <div class="spacer"></div>

      <!-- 使用人員 -->
      <section class="panel" id="panelUsers" style="display:none">
        <div class="panel-header">
          <div class="panel-title">使用此程式的員工 <span id="progTitle" class="badge"></span></div>
          <div class="panel-actions hint" id="usersHint">尚未選擇程式</div>
        </div>
        <div class="panel-body">
          <div class="table-wrap">
            <table id="tblUsers">
              <thead>
                <tr>
                  <th>員工編號</th>
                  <th>員工姓名</th>
                  <th>任職單位</th>
                  <th>作業權限</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer">提示：預設不載入資料；請輸入條件後按查詢。</footer>
  </div>

  <script>
    const qProgId = document.getElementById('qProgId');
    const qProgName = document.getElementById('qProgName');
    const tbody = document.querySelector('#tblPrograms tbody');
    const hint = document.getElementById('hint');
    const panelUsers = document.getElementById('panelUsers');
    const progTitle = document.getElementById('progTitle');
    const usersHint = document.getElementById('usersHint');
    const usersBody = document.querySelector('#tblUsers tbody');

    function esc(s){
      return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
    }

    function scrollToEl(el){
      if (!el) return;
      try {
        const y = el.getBoundingClientRect().top + window.pageYOffset - 72;
        window.scrollTo({ top: y, behavior: 'smooth' });
      } catch (e) { /* no-op */ }
    }

    async function fetchPrograms(){
      const p = new URLSearchParams();
      if (qProgId.value.trim()) p.set('ProgId', qProgId.value.trim());
      if (qProgName.value.trim()) p.set('ProgName', qProgName.value.trim());
      const url = '/api/programs' + (p.toString()?('?' + p.toString()):'');
      const r = await fetch(url);
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    }

    async function fetchProgramUsers(progId){
      const r = await fetch('/api/program/employees?ProgId=' + encodeURIComponent(progId));
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    }

    function renderRows(rows){
      tbody.innerHTML = '';
      const list = Array.isArray(rows) ? rows : [];
      for (const it of list){
        // 兼容 list_programs/search_programs 欄位命名
        const id = it.ProgId ?? it.progId ?? it.code ?? '';
        const name = it.ProgName ?? it.progName ?? it.name ?? '';
        const users = Number(it.UserCount ?? it.userCount ?? it.Count ?? it.count ?? 0) || 0;
        const tr = document.createElement('tr');
        const link = `/ModifyProgram?ProgId=${encodeURIComponent(id)}`;
        tr.innerHTML = `
          <td>${esc(id)}</td>
          <td>${esc(name)}</td>
          <td><button class="link" data-prog="${esc(id)}" data-name="${esc(name)}" type="button">${users}</button></td>
          <td><a class="link" href="${link}">編輯</a></td>
        `;
        tbody.appendChild(tr);
        // 將使用人數由按鈕改為 <a> 連結樣式（保持點擊後顏色不變）
        (function(){
          const btn = tr.querySelector('button[data-prog]');
          if (!btn) return;
          const a = document.createElement('a');
          a.href = '#';
          a.className = 'link';
          a.setAttribute('data-prog', id);
          a.setAttribute('data-name', name);
          a.textContent = String(users);
          btn.replaceWith(a);
        })();
      }
      if (hint) hint.textContent = `顯示 ${list.length} 筆`;
    }

    function renderUsers(list){
      usersBody.innerHTML = '';
      const arr = Array.isArray(list) ? list : [];
      for (const e of arr){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${esc(e.EmployeeId || '')}</td>
          <td>${esc(e.EmployeeName || '')}</td>
          <td>${esc(e.UnitName || '')}</td>
          <td>${esc(e.RoleName || '')}</td>
        `;
        usersBody.appendChild(tr);
      }
      if (usersHint) usersHint.textContent = `顯示 ${arr.length} 筆`;
    }

    document.getElementById('btnSearchProg').addEventListener('click', async () => {
      try {
        const data = await fetchPrograms();
        renderRows(data);
      } catch (e) {
        console.error(e);
      }
    });

    document.getElementById('btnClearProg').addEventListener('click', () => {
      qProgId.value=''; qProgName.value='';
      tbody.innerHTML=''; if (hint) hint.textContent='顯示 0 筆';
      if (panelUsers){ panelUsers.style.display='none'; usersBody.innerHTML=''; usersHint.textContent='尚未選擇程式'; progTitle.textContent=''; }
    });

    // 點選使用人數顯示使用此程式的員工（支援 a/button）
    tbody.addEventListener('click', async (ev) => {
      const el = ev.target.closest('a[data-prog],button[data-prog]');
      if (!el) return;
      if (el.tagName === 'A') ev.preventDefault();
      const pid = el.getAttribute('data-prog') || '';
      const pname = el.getAttribute('data-name') || '';
      if (!pid) return;
      if (panelUsers) panelUsers.style.display = '';
      // Scroll the page to the panel position for visibility
      scrollToEl(panelUsers);
      if (progTitle) progTitle.textContent = `${pid}｜${pname}`;
      if (usersHint) usersHint.textContent = '查詢中...';
      try {
        const list = await fetchProgramUsers(pid);
        renderUsers(list);
      } catch (e) {
        console.error(e);
        if (usersHint) usersHint.textContent = '讀取失敗';
      }
    });
  </script>
</body>
</html>
