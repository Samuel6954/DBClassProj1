<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>程式代碼管理 | DBProj01_05_Program</title>
  <link rel="stylesheet" href="assets/tech.css" />
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="topbar-inner">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">ERP 稽核輔助｜程式代碼管理</div>
        <div class="breadcrumbs">首頁 / 基礎資料 / 程式代碼管理</div>
      </div>
    </header>

    <main class="container">
      <!-- 查詢條件 -->
      <section class="panel subtle-grid">
        <div class="panel-header">
          <div class="panel-title">查詢條件</div>
          <div class="panel-actions"><a class="btn primary" href="/ModifyProgram">新增</a></div>
        </div>
        <div class="panel-body">
          <div class="grid">
            <div class="col-4">
              <label for="qProgId">程式代碼</label>
              <input id="qProgId" type="search" placeholder="例如：PRG_RECRUIT_APPLY" />
            </div>
            <div class="col-4">
              <label for="qProgName">程式名稱</label>
              <input id="qProgName" type="search" placeholder="例如：招募申請" />
            </div>
            <div class="col-12">
              <div class="form-actions">
                <button id="btnClearProg" class="btn" type="button">清除</button>
                <button id="btnSearchProg" class="btn primary" type="button">查詢</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <div class="spacer"></div>

      <!-- 查詢結果 -->
      <section class="panel">
        <div class="panel-header">
          <div class="panel-title">查詢結果</div>
          <div class="panel-actions hint" id="hint">顯示 0 筆</div>
        </div>
        <div class="panel-body">
          <div class="table-wrap">
            <table id="tblPrograms">
              <thead>
                <tr>
                  <th>程式代碼</th>
                  <th>程式名稱</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer">提示：預設不載入資料；請輸入條件後按查詢。</footer>
  </div>

  <script>
    const qProgId = document.getElementById('qProgId');
    const qProgName = document.getElementById('qProgName');
    const tbody = document.querySelector('#tblPrograms tbody');
    const hint = document.getElementById('hint');

    function esc(s){
      return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
    }

    async function fetchPrograms(){
      const p = new URLSearchParams();
      if (qProgId.value.trim()) p.set('ProgId', qProgId.value.trim());
      if (qProgName.value.trim()) p.set('ProgName', qProgName.value.trim());
      const url = '/api/programs' + (p.toString()?('?' + p.toString()):'');
      const r = await fetch(url);
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    }

    function renderRows(rows){
      tbody.innerHTML = '';
      const list = Array.isArray(rows) ? rows : [];
      for (const it of list){
        // 兼容 list_programs/search_programs 欄位命名
        const id = it.ProgId ?? it.progId ?? it.code ?? '';
        const name = it.ProgName ?? it.progName ?? it.name ?? '';
        const tr = document.createElement('tr');
        const link = `/ModifyProgram?ProgId=${encodeURIComponent(id)}`;
        tr.innerHTML = `
          <td>${esc(id)}</td>
          <td>${esc(name)}</td>
          <td><a class="link" href="${link}">編輯</a></td>
        `;
        tbody.appendChild(tr);
      }
      if (hint) hint.textContent = `顯示 ${list.length} 筆`;
    }

    document.getElementById('btnSearchProg').addEventListener('click', async () => {
      try {
        const data = await fetchPrograms();
        renderRows(data);
      } catch (e) {
        console.error(e);
      }
    });

    document.getElementById('btnClearProg').addEventListener('click', () => {
      qProgId.value=''; qProgName.value='';
      tbody.innerHTML=''; if (hint) hint.textContent='顯示 0 筆';
    });
  </script>
</body>
</html>
