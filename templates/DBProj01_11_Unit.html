<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>單位代碼維護 | DBProj01_11_Unit</title>
  <link rel="stylesheet" href="assets/tech.css" />
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="topbar-inner">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">ERP 稽核輔助｜單位代碼維護</div>
        <div class="breadcrumbs"><a href="/" style="text-decoration:none;color:inherit;">首頁</a> / 單位代碼管理 / 單位代碼維護</div>
      </div>
    </header>

    <main class="container">
      <form class="panel subtle-grid" autocomplete="off" onsubmit="return false;">
        <div class="panel-header">
          <div class="panel-title">基本資料</div>
          <div class="panel-actions">
            <a class="btn" href="/Unit">返回清單</a>
          </div>
        </div>
        <div class="panel-body">
          <div class="grid">
            <div class="col-6">
              <label for="UnitId">單位代碼</label>
              <input id="UnitId" name="UnitId" type="text" placeholder="HR001" required />
            </div>
            <div class="col-6">
              <label for="UnitName">單位名稱</label>
              <input id="UnitName" name="UnitName" type="text" placeholder="人力資源部" required />
            </div>
            <div class="col-6">
              <label for="ManagerUser">主管工號</label>
              <input id="ManagerUser" name="ManagerUser" type="text" placeholder="U0001" />
            </div>
            <div class="col-12">
              <label for="WorkIntroduce">作業說明</label>
              <textarea id="WorkIntroduce" name="WorkIntroduce" placeholder="簡述本單位職掌與作業內容"></textarea>
            </div>
            <div class="col-12 form-actions">
              <button class="btn danger" type="button" id="btnDelete" disabled>刪除</button>
              <div class="right"></div>
              <button class="btn" type="reset" id="btnClear">清除</button>
              <button id="btnSave" class="btn success" type="button">儲存</button>
            </div>
          </div>
        </div>
      </form>
    </main>

    <footer class="footer">提示：新增模式會檢查代碼是否重複；編輯模式不可修改代碼。</footer>
  </div>

  <script>
    function getQuery(name){ const u=new URL(location.href); return u.searchParams.get(name)||''; }
    function qs(sel, root=document){ return root.querySelector(sel); }

    const inpUnitId = qs('#UnitId');
    const inpUnitName = qs('#UnitName');
    const inpManager = qs('#ManagerUser');
    const inpIntro = qs('#WorkIntroduce');
    const btnSave = qs('#btnSave');
    const btnClear = qs('#btnClear');
    const btnDelete = qs('#btnDelete');

    async function fetchJSON(url, options){
      const r = await fetch(url, options);
      if (!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }

    let MODE = 'insert';
    async function loadData(){
      const unitId = getQuery('UnitId');
      if (!unitId){
        inpUnitId.readOnly = false; // 新增模式
        MODE = 'insert';
        return;
      }
      try{
        const data = await fetchJSON('/api/unit?UnitId=' + encodeURIComponent(unitId));
        if (!data || !data.UnitId){ alert('沒有此代碼的單位資料：' + unitId); history.back(); return; }
        inpUnitId.value = data.UnitId || '';
        inpUnitName.value = data.UnitName || '';
        inpManager.value = data.ManagerUser || '';
        inpIntro.value = data.WorkIntroduce || '';
        inpUnitId.readOnly = true; // 編輯模式不可改代碼
        MODE = 'update';
        btnDelete.disabled = false;
      }catch(e){ console.error(e); alert('讀取資料失敗'); history.back(); }
    }

    btnSave.addEventListener('click', async () => {
      const unitId = (inpUnitId.value||'').trim();
      const unitName = (inpUnitName.value||'').trim();
      const manager = (inpManager.value||'').trim();
      const intro = (inpIntro.value||'').trim();
      if (!unitId || !unitName){ alert('請填寫單位代碼與單位名稱'); return; }
      try{
        if (MODE === 'insert'){
          try{
            const r = await fetch('/api/unit?UnitId=' + encodeURIComponent(unitId));
            if (r.ok){ alert('代碼已存在，請更換 UnitId'); return; }
          }catch(_){ /* 404 -> ok */ }
        }
        if (manager){
          const chk = await fetchJSON('/api/employees/exists?EmployeeId=' + encodeURIComponent(manager));
          if (!chk || !chk.exists){ alert('沒有此主管工號的員工，請確認：' + manager); return; }
        }
        const r = await fetch('/api/unit', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ UnitId: unitId, UnitName: unitName, ManagerUser: manager, WorkIntroduce: intro, mode: MODE })
        });
        const res = await r.json();
        if (!r.ok || !res.ok){ alert(res.error || '儲存失敗'); return; }
        alert(res.mode==='insert' ? '已新增' : '已儲存');
        if (res.mode==='insert') location.href = '/ModifyUnit?UnitId=' + encodeURIComponent(unitId);
      }catch(e){ console.error(e); alert('儲存時發生錯誤'); }
    });

    btnClear.addEventListener('click', () => { if (!inpUnitId.readOnly) inpUnitId.value=''; inpUnitName.value=''; inpManager.value=''; inpIntro.value=''; });
    btnDelete.addEventListener('click', async () => {
      const unitId = (inpUnitId.value||'').trim();
      if (!unitId) return;
      if (!confirm('確定要刪除此單位：' + unitId + '？')) return;
      try{
        const r = await fetch('/api/unit?UnitId=' + encodeURIComponent(unitId), { method: 'DELETE' });
        const res = await r.json().catch(()=>({}));
        if (!r.ok || !res.ok){
          alert(res.error || '刪除失敗'); return;
        }
        alert('已刪除');
        location.href = '/Unit';
      }catch(e){ console.error(e); alert('刪除時發生錯誤'); }
    });
    loadData();
  </script>
</body>
<!-- DBProj01_11_Unit form -->
</html>
